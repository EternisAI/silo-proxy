server {
    listen ${NGINX_PORT};
    server_name ~^(?<agentid>[^.]+)\.silo\.local$;

    set $agent_port '';
    set $agent_host '';

    location / {
        access_by_lua_block {
            local http = require "resty.http"
            local cjson = require "cjson"

            local agentid = ngx.var.agentid
            if not agentid or agentid == "" then
                ngx.status = 400
                ngx.say('{"error": "Missing agent ID in subdomain"}')
                ngx.exit(400)
            end

            local httpc = http.new()
            httpc:set_timeout(5000)

            local api_url = "${BACKEND_URL}/api/agent/" .. agentid .. "/state"
            local res, err = httpc:request_uri(api_url, {
                method = "GET",
                headers = {
                    ["Content-Type"] = "application/json",
                }
            })

            if not res then
                ngx.log(ngx.ERR, "Failed to query agent API: ", err)
                ngx.status = 503
                ngx.say('{"error": "Failed to query agent state"}')
                ngx.exit(503)
            end

            if res.status ~= 200 then
                ngx.log(ngx.ERR, "Agent API returned status: ", res.status)
                ngx.status = 503
                ngx.say('{"error": "Agent not available"}')
                ngx.exit(503)
            end

            local ok, data = pcall(cjson.decode, res.body)
            if not ok or not data.agent_port then
                ngx.log(ngx.ERR, "Invalid response from agent API")
                ngx.status = 503
                ngx.say('{"error": "Invalid agent state response"}')
                ngx.exit(503)
            end

            ngx.var.agent_port = data.agent_port
            ngx.var.agent_host = "echo-" .. agentid .. ":" .. data.agent_port
        }

        proxy_pass http://$agent_host$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Agent-ID $agentid;
    }

    access_log /dev/stdout;
    error_log /dev/stderr;
}
