server {
    listen ${NGINX_PORT};
    server_name ~^(?<agentid>[^.]+)\.silo\.local$;

    set $agent_port '';
    set $agent_host '';

    location / {
        access_by_lua_block {
            local http = require "resty.http"
            local cjson = require "cjson"

            local agentid = ngx.var.agentid
            if not agentid or agentid == "" then
                ngx.status = 400
                ngx.say('{"error": "Missing agent ID in subdomain"}')
                ngx.exit(400)
            end

            local httpc = http.new()
            httpc:set_timeout(5000)

            local api_url = "${BACKEND_URL}/agents"

            local res, err = httpc:request_uri(api_url, {
                method = "GET",
                headers = {
                    ["Content-Type"] = "application/json",
                }
            })

            if not res then
                ngx.log(ngx.ERR, "Failed to query agents API: ", err)
                ngx.status = 503
                ngx.say('{"error": "Failed to query agents API"}')
                ngx.exit(503)
            end

            if res.status ~= 200 then
                ngx.log(ngx.ERR, "Agents API returned status: ", res.status)
                ngx.status = 503
                ngx.say('{"error": "Agents API unavailable"}')
                ngx.exit(503)
            end

            local ok, data = pcall(cjson.decode, res.body)
            if not ok or not data.agents then
                ngx.log(ngx.ERR, "Invalid response from agents API")
                ngx.status = 503
                ngx.say('{"error": "Invalid agents API response"}')
                ngx.exit(503)
            end

            local agent_port = nil
            for _, agent in ipairs(data.agents) do
                if agent.agent_id == agentid then
                    agent_port = agent.port
                    break
                end
            end

            if not agent_port then
                ngx.log(ngx.ERR, "Agent not found: ", agentid)
                ngx.status = 404
                ngx.say('{"error": "Agent not found"}')
                ngx.exit(404)
            end

            ngx.var.agent_port = agent_port
            ngx.var.agent_host = "backend:" .. agent_port
        }

        proxy_pass http://$agent_host$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Agent-ID $agentid;
    }

    access_log /dev/stdout;
    error_log /dev/stderr;
}
